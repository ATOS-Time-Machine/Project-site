<!DOCTYPE html>
<html>
    <head>
    <!--Materialize CSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/2016/group20/css/prism.css">
    <link rel="stylesheet" href="/2016/group20/css/custom.css">
</head>
    <body>
        <nav class="navbar-fixed">
    <nav class="light-blue darken-1">
        <div class="nav-wrapper">
            <div class="brand-logo left active waves-effect wave-light">
                <a id="logo-container"
                   href="/2016/group20/">Group
                    20</a>
            </div>
            <ul class="right hide-on-med-and-down">
                <li><a href="https://github.com/orgs/ATOS-Time-Machine/" target="_blank"><img src="/2016/group20/img/github2.png"></a></li>
                <li><a href="/2016/group20/planning">Planning</a></li>
                <li><a href="/2016/group20/requirements">Requirements</a></li>
                <li><a class="dropdown-button" data-activates="research_dropdown" data-beloworigin="true">Research<i
                        class="material-icons right">arrow_drop_down</i></a>
                </li>
                <li><a href="/2016/group20/hci">HCI</a></li>
                <li><a href="/2016/group20/design">Design</a></li>
                <li><a href="/2016/group20/testing">Testing</a></li>
                <!--<li><a class="dropdown-button" data-activates="eval_dropdown" data-beloworigin="true">Evaluation<i-->
                        <!--class="material-icons right">arrow_drop_down</i></a></li>-->
                <li><a href="/2016/group20/evaluation">Evaluation</a></li>
                <li><a class="dropdown-button" data-activates="management_dropdown" data-beloworigin="true">Management<i
                        class="material-icons right">arrow_drop_down</i></a>
                </li>
            </ul>
        </div>
    </nav>
</nav>

<ul id="management_dropdown" class="dropdown-content">
    <li><a href="/2016/group20/management/api">API</a></li>
    <li><a href="/2016/group20/management/system">System Manual</a></li>
    <li><a href="/2016/group20/management/timeline">Timeline</a></li>
</ul>

<ul id="research_dropdown" class="dropdown-content">
    <li><a href="/2016/group20/research/dev_methods">Development Methods</a></li>
    <li><a href="/2016/group20/research/technical">Technical Report</a></li>
    <li><a href="/2016/group20/research/investigation">Investigation</a></li>
</ul>

<ul id="eval_dropdown" class="dropdown-content">
    <li><a href="/2016/group20/evaluation/achievements">Achievements</a></li>
    <li><a href="/2016/group20/evaluation/critical">Critical Assessment</a></li>
</ul>

        <header>
    <div class="light-blue lighten-1">
        <br><br>

        <h1 class="center white-text">System Manual</h1>
        <br><br>
    </div>
</header>
<nav class="nav-extended">
    <div class="nav-wrapper">
        <div class="container col">
            <a href="/2016/group20/" class="breadcrumb">Home</a>
            <a href="" class="breadcrumb">System Manual</a>
        </div>
    </div>
    <div class="white-text">
        <ul class="tabs tabs-transparent center" style="width:20em;">
            <li class="tab col s6">
                <a href="#host">Host Setup</a>
            </li>
            <li class="tab col s6">
                <a href="#system">page2</a>
            </li>
        </ul>
    </div>
</nav>

<!--<p>management/system.html</p>-->
<!--<nav class="nav-extended">
    <div class="nav-content">
        <ul class="tabs tabs-transparent">
            <li class="tab">Test</li>
        </ul>
    </div>
</nav>-->

<div>
    <div class="row">
        <div class="col s12 m9 l10">
            
                <div id="setup" class="section scrollspy">
                    <h3>Host Setup</h3>
                    <p>
    For this application, we make use of NodeJS and MySQL to power our backend API and database respectively. For our frontend which is used to demonstrate 
    the capabilities of our API, we have employed Apache2 HTTP Server. These tools are available on a variety of operating systems and as a result, 
    this setup can be hosted on a vareity of machines.
</p>

<h4>Server</h4>
<p>
    For our demonstration purposes, we hosted on Ubuntu Server 16.04, making use of Microsoft Azure's virtual machine service. As part of 
    this setup, HTTP traffic on port 80 needs to be allowed. This can be done on the configuration page of the Azure portal or any 
    hosting service you make use of.
</p>

<h4>Software Installation</h4>
<p>For our application, we will be installing:</p>
<ul class="browser-default">
    <li>Apache2</li>
    <li>MySQL</li>
    <li>NodeJS</li>
</ul>
<p>Additionally we will install Git for development purposes.</p>
<p>The following code will install the necessary packages on Ubuntu.</p>
<pre><code class="language-bash">
sudo apt-get update
sudo apt-get install apache2 mysql nodejs

# Installs NPM, package manager for Node
sudo apt-get install npm

# Install Git
sudo apt-get install git
</code></pre>

                </div>
            
                <div id="deploy" class="section scrollspy">
                    <h3>Deployment</h3>
                    First we need to setup 2 bare repositories on our server, one for the frontend and another for the backend. This can be setup
anywhere but we chose <code class="language-bash">/var/repo</code>.

<pre><code class="language-bash">
# Make the parent repo directory
cd /var/
sudo mkdir repo && cd repo/

# Give ourselves ownership of the directory.
# While we're at it, claim /var/www/html where apache2 hosts
sudo chown -R `whoami`:`id -gn` /var/repo
sudo chown -R `whoami`:`id -gn` /var/www/html

# Make the 2 directories for our repositories
mkdir frontend && mkdir backend
</code></pre>

<p>Now that we've made the folders for our repositories, we need to create the bare git repos. Cd into both directories and do the following</p>
<pre><code class="language-bash">
git init --bare
</code></pre>

Now we need to create a hook to deploy the systems. We will start with the frontend:

<pre><code class="language-bash">
# First cd into the hooks directory for our frontend
cd /var/repo/frontend/hooks

# Create and edit a file called post-receive
vim post-receive

# Make file executable
chmod +x post-receive
</code></pre>

Our post-receive file looks like this:
<pre><code class="language-bash">
#!/bin/bash
while read oldrev newrev ref
do
        if [[ $ref =~ .*/master$ ]];
        then
                echo "Master ref received. Deploying master branch..."
                git --work-tree=/var/www/html --git-dir=/var/repo/frontend checkout -f
        else
                echo "Ref $ref successfully received. Doing nothing: only the master branch may be deployed on this server."
        fi
done
</code></pre>
This will result in new pushes to the master branch automatically being unpackaged in the <code class="language-bash">/var/www/html</code> directory
which is the root of Apache's host directory. There are also some output messages to provide confirmation.

<p>Now create a backend post-receive hook:</p>
<pre><code class="language-bash">
cd /var/repo/backend/hooks
vim post-receive
chmod +x post-receive
</code></pre>
This post-receive hook will be different as it needs to manage our NodeJS application:
<pre><code class="language-bash">
#!/bin/bash
while read oldrev newrev ref
do
        if [[ $ref =~ .*/master$ ]];
        then
                echo "Master ref received. Deploying master branch..."
                git --work-tree=/var/www/backend --git-dir=/var/repo/backend checkout -f
        else
                echo "Ref $ref successfully received. Doing nothing: only the master branch may be deployed on this server."
        fi
done

chmod +x /var/www/backend/app.js

if (service timemachine status > /dev/null)
then
        echo "Service running. Stopping service..."
        sudo service timemachine stop > /dev/null
        echo "Service stopped."
else
        echo "Service not running.."
fi

echo "Installing packages.."
npm --prefix /var/www/backend/ install /var/www/backend
echo "Starting service..."
sudo service timemachine start > /dev/null

if (service timemachine status > /dev/null)
then
        echo "Timemachine service started successfully."
else
        echo "Timemachine service unable to be started. Please debug."
fi
</code></pre>
This script checks if the application service is running and stops it if it is. It will then perform an NPM install in case
any new dependency packages are required for the application and will then start the service.

<p>The frontend and backend can now be deployed to by pushing to it.</p>
<pre><code class="language-bash">
# Add remote to your local git clone of the frontend repository
git remote add live ssh://[[user]]@[[server address]]:/var/repo/frontend
git push live master

# For the backend
git remote add live ssh://[[user]]@[[server address]]:/var/repo/backend
git push live master
</code></pre>

                </div>
            
                <div id="example" class="section scrollspy">
                    <h3>Example</h3>
                    <p>This is an example section.</p>
                </div>
            
        </div>
        <div class="">
            <div class="col hide-on-small-only m3 l2">
    <ul class="section table-of-contents fixed">
        
        <li><a href="#setup">Host Setup</a></li>
        
        <li><a href="#deploy">Deployment</a></li>
        
        <li><a href="#example">Example</a></li>
        
    </ul>
</div>
        </div>
    </div>
</div>

        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<script src="/2016/group20/js/prism.js"></script>
<script src="/2016/group20/js/init.js"></script>
        <!--<footer class="page-footer teal">
    <div class="container">
        <div class="row">
            <div class="col l6 s12">
                <h5 class="white-text">Accolades</h5>
                <ul>
                    <li>
                        <a class="white-text"
                           href="https://www.cms.gov/Research-Statistics-Data-and-Systems/CMS-Information-Technology/XLC/Downloads/SelectingDevelopmentApproach.pdf"
                           target="_blank">CMS</a></li>
                    <li><a class="white-text" href="https://nodejs.org/en/" target="_blank">NodeJS</a></li>
                    <li><a class="white-text" href="https://www.djangoproject.com/" target="_blank">Django</a></li>
                    <li>
                        <a class="white-text"
                           href="https://docs.microsoft.com/en-us/aspnet/core/#build-web-ui-and-web-apis-using-aspnet-core-mvc"
                           target="_blank">Microsoft</a></li>
                    <li><a class="white-text" href="https://uk.atos.net/en-uk/home.html" target="_blank">ATOS</a></li>
                </ul>
            </div>

            <div class="col l3 s12">
                <h5 class="white-text">Biweekly Reports</h5>
                <ul>
                    <li><a class="white-text"
                           href="https://docs.google.com/document/d/1tx0pmLRZE4RZby07I-bL01cnztbZEeV7zFHNJzchCA0"
                           target="_blank">12/10/2016</a></li>
                    <li><a class="white-text"
                           href="https://docs.google.com/document/d/1h0_8CRuApI9n4V0DEOgf-Uah8vBLOq2F20pLlwKWq3c"
                           target="_blank">28/10/2016</a></li>
                    <li><a class="white-text"
                           href="https://docs.google.com/document/d/1I9c4WwxtuN11u64bdrsZ8m67RBRk1Ombr153coM1_Cc/"
                           target="_blank">18/11/2016</a>
                    </li>
                    <li>
                        <a class="white-text"
                           href="https://docs.google.com/document/d/1py0Yt9w4F3AYteg14Z1dICWHzn09l1gYkJlkfAqa5lg"
                           target="_blank">02/12/2016</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            Made by <a class="brown-text text-lighten-3" href="https://github.com/JayJeyaruban" target="_blank">Jay
            Jeyaruban</a>, <a class="brown-text text-lighten-3" href="https://github.com/TheRurry" target="_blank">Ryan
            Collins</a>, <a class="brown-text text-lighten-3" href="https://github.com/giorgio-arena" target="_blank">Giorgio
            Arena</a>
        </div>
    </div>
</footer>-->
    </body>
</html>